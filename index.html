<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Proses Produksi</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk Dashboard Analitik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Memuat Date Adapter untuk Chart.js (Opsional tapi membantu jika menggunakan skala waktu) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* Mengatur font default dan dark mode (Tema Zinc/Hitam/Putih) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #18181b; /* Zinc 900 */
            color: #ffffff;
        }
        
        /* Style untuk App View */
        .app-view {
            background-color: #18181b; 
            min-height: 100vh;
        }
        
        /* Style Login */
        .login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .login-card {
            background-color: #27272a;
            border-top: 4px solid #22c55e;
        }
        
        /* Style Main Menu Card */
        .menu-card {
            background-color: #27272a; /* Zinc 800 */
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-radius: 0.75rem; 
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border-left-width: 4px;
        }
        .menu-card:hover {
            background-color: #3f3f46; /* Zinc 700 */
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .icon-wrapper {
            margin-bottom: 1rem;
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Style Tabel */
        .monitor-table {
            background-color: #27272a;
        }
        .monitor-table th {
            background-color: #18181b;
            color: #9ca3af;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Style Tombol */
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        /* Dashboard Card Specifics */
        .process-card {
            background-color: #27272a;
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border-top: 4px solid #22c55e;
        }
        .summary-card {
            background-color: #27272a;
            border-radius: 0.75rem;
            padding: 1.5rem;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border-left: 4px solid;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .chart-wrapper {
            position: relative;
            height: 160px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background-color: #3f3f46;
            border: 1px solid #52525b;
            border-radius: 0.5rem;
            color: white;
        }
        .form-input:focus {
            outline: none;
            border-color: #22c55e;
            ring: 2px solid #22c55e;
        }
        
        /* Custom styles for the Timeline chart legend */
        .timeline-legend-item {
            display: flex;
            align-items: center;
            margin-right: 1.5rem;
        }
        .timeline-legend-color {
            width: 1rem;
            height: 0.5rem;
            margin-right: 0.5rem;
            border-radius: 2px;
        }
    </style>
</head>
<body>

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="min-h-screen"></div>

    <script type="module">
        // --- 1. KONFIGURASI DAN STATE ---
        // Ganti dengan ID Google Sheet Anda
        const GOOGLE_SHEET_ID = '1QRlL9YUAjWjQwFlXoEX9SK8hA2DeX6i0BPw3WCEid0w'; 
        // Ganti dengan URL Script Web App Anda
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz8WCZcK1zjIm9GsUiA3Dd3ftL6EA6PsdZIKaLtZp7wzDYBq1Fl9hHeLPQsS0JLYgai/exec';
        
        const SHEETS = {
            DASHBOARD: 'dashboardproses',
            DETAIL: 'detailprogress',
            USER: 'Usercontrol',
            PLAN: 'planproses'
        };

        let currentUser = null;
        let dashboardData = [];
        let dashboardHeaders = [];
        let chartInstances = {}; 
        let selectedMachine = null;
        
        // --- 2. FUNGSI UTILITAS (FETCH & PARSE) ---
        
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return parseFloat(num).toLocaleString('en-US');
        }

        // PERBAIKAN: Fungsi konversi waktu yang lebih tangguh
        // Menerima string "HH:mm" atau angka desimal (0.5 = jam 12 siang)
        function timeToMinutes(input) {
            if (input === null || input === undefined || input === '') return null;

            // Jika input adalah angka (dari Google Sheet seringkali 0.xxxxx)
            if (typeof input === 'number') {
                // Konversi hari ke menit (1 hari = 1440 menit)
                return Math.round(input * 1440);
            }

            const str = String(input).trim();
            // Ganti titik dengan titik dua jika user input manual "08.00"
            const normalized = str.replace('.', ':');
            const parts = normalized.split(':');
            
            if (parts.length < 2) return null;
            
            let totalMinutes = parseInt(parts[0]) * 60 + parseInt(parts[1]);
            if (parts.length > 2) totalMinutes += parseInt(parts[2]) / 60; 

            return totalMinutes;
        }

        function minutesToTime(minutes) {
            if (minutes === null || isNaN(minutes)) return '';
            let totalMinutes = Math.round(minutes);
            let h = Math.floor(totalMinutes / 60);
            let m = Math.floor(totalMinutes % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }
        
        function minutesToTimeWithSeconds(minutes) {
             if (minutes === null || isNaN(minutes)) return '';
            let totalSeconds = Math.round(minutes * 60);
            let h = Math.floor(totalSeconds / 3600);
            let m = Math.floor((totalSeconds % 3600) / 60);
            let s = totalSeconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }


        async function fetchSheetData(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                if (!jsonText) throw new Error("Format data Sheet tidak valid.");
                const json = JSON.parse(jsonText);
                if (json.status !== 'ok') {
                    throw new Error(`Gviz Error: ${json.errors ? json.errors[0].message : 'Query error'}`);
                }
                return parseGVizData(json);
            } catch (error) {
                console.error(`Gagal mengambil data sheet ${sheetName}:`, error);
                throw error;
            }
        }

        function parseGVizData(json) {
            const maxCols = 15; 
            const cols = json.table.cols.slice(0, maxCols).map(col => (col.label || col.id).toUpperCase().trim());
            const rows = json.table.rows;
            const data = rows.map(row => {
                let obj = {};
                cols.forEach((col, index) => {
                    const cell = row.c[index];
                    // PERBAIKAN UTAMA: Ambil nilai terformat (f) jika ada, agar jam terbaca sebagai "08:00" bukan angka
                    // Jika tidak ada f, ambil v.
                    let val = cell ? (cell.f || cell.v) : ''; 
                    // Pastikan tidak null
                    if (val === null) val = '';
                    obj[col] = val; 
                });
                return obj;
            });
            return { headers: cols, data: data };
        }

        // --- 3. NAVIGASI & RENDERING UTAMA ---

        function navigate(page) {
            localStorage.setItem('currentMonitorPage', page);
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
            const container = document.getElementById('app-container');
            container.innerHTML = ''; 

            if (page !== 'login' && !currentUser) {
                renderLogin();
                return;
            }

            switch (page) {
                case 'login': renderLogin(); break;
                case 'mainMenu': renderMainMenu(); break;
                case 'monitorDashboard': renderMonitorDashboard(); break;
                case 'detailMesin': renderDetailMesin(); break;
                case 'kontrolMesin': renderKontrolMesin(); break;
                case 'detailProgress': renderDetailProgress(); break;
                case 'informasi': renderInformasi(); break;
                case 'about': renderAbout(); break;
                default: renderMainMenu(); break;
            }
        }

        function createHeader(title, subtitle = '', showBackBtn = true, backDestination = 'mainMenu') {
            const username = currentUser ? currentUser.username : 'Guest';
            const role = currentUser ? currentUser.role : '';
            let backButtonHtml = '';
            if (showBackBtn) {
                backButtonHtml = `
                    <button onclick="navigate('${backDestination}')" class="mr-4 text-gray-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    </button>
                `;
            }
            return `
                <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b border-gray-700 pb-4">
                    <div class="flex items-center">
                        ${backButtonHtml}
                        <div class="flex items-center gap-4">
                            <div class="h-10 w-10 bg-green-900 rounded-lg flex items-center justify-center font-bold text-xl text-green-400 border border-green-700">M</div>
                            <div>
                                <h1 class="text-2xl font-bold text-green-500 tracking-wide uppercase">${title}</h1>
                                <p class="text-sm text-gray-400">${subtitle}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center gap-3 bg-zinc-800 px-4 py-2 rounded-lg border border-zinc-700">
                        <div class="text-right">
                            <p class="text-xs text-gray-400">User: <span class="text-green-400 font-bold">${username}</span></p>
                            <p class="text-xs text-gray-500 uppercase tracking-wider">${role}</p>
                        </div>
                        <button onclick="handleLogout()" class="ml-2 p-2 text-red-400 hover:bg-zinc-700 rounded-full transition" title="Logout">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </header>
            `;
        }

        // --- 4. LOGIC PILIH MESIN ---
        window.openMachineDetail = (namaMesin) => {
            selectedMachine = namaMesin;
            navigate('detailMesin');
        };

        // --- 5. RENDER HALAMAN ---

        function renderLogin() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="login-view">
                    <div class="login-card w-full max-w-sm p-8 rounded-xl shadow-2xl">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-white mb-2">Monitoring Produksi</h1>
                            <p class="text-gray-400 text-sm">Masuk untuk mengakses sistem</p>
                        </div>
                        <form onsubmit="handleLoginSubmit(event)">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                                <input type="text" id="loginUser" class="form-input" placeholder="User ID" required>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                                <input type="password" id="loginPass" class="form-input" placeholder="Password" required>
                            </div>
                            <div id="login-msg" class="hidden mb-4 p-3 bg-red-900/50 text-red-200 text-sm rounded border border-red-800 font-semibold"></div>
                            <button type="submit" id="btn-login" class="w-full btn-primary bg-green-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-green-700">LOGIN</button>
                        </form>
                    </div>
                </div>
            `;
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');
            const userIn = document.getElementById('loginUser').value.trim();
            const passIn = document.getElementById('loginPass').value.trim();

            btn.disabled = true;
            btn.textContent = 'Memverifikasi...';
            msg.classList.add('hidden');

            try {
                const result = await fetchSheetData(SHEETS.USER);
                const user = result.data.find(row => 
                    String(row.USERNAME || '').trim() === userIn && 
                    String(row.PASSWORD || '').trim() === passIn
                );

                if (user) {
                    const role = String(user.ROLE || 'User').trim(); 
                    currentUser = { username: user.USERNAME, role: role };
                    sessionStorage.setItem('monitorUser', JSON.stringify(currentUser));
                    navigate('mainMenu'); 
                } else {
                    throw new Error('Username atau Password salah');
                }
            } catch (err) {
                msg.innerHTML = err.message || 'Gagal koneksi ke database.';
                msg.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'LOGIN';
            }
        }

        function renderMainMenu() {
            const container = document.getElementById('app-container');
            const userRole = currentUser ? currentUser.role : 'User';
            const allMenuItems = [
                {
                    id: 'monitorDashboard',
                    title: 'DASHBOARD MONITOR',
                    desc: 'Status Efisiensi Mesin Realtime',
                    color: 'blue',
                    icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>',
                    roles: ['Administrator', 'User']
                },
                {
                    id: 'kontrolMesin',
                    title: 'KONTROL MESIN',
                    desc: 'Update Status & Output Produksi',
                    color: 'red',
                    icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>',
                    roles: ['Administrator'] 
                },
                {
                    id: 'detailProgress',
                    title: 'DETAIL PROGRESS',
                    desc: 'Tabel Data Produksi Lengkap',
                    color: 'emerald',
                    icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>',
                    roles: ['Administrator', 'User']
                },
                {
                    id: 'informasi',
                    title: 'INFORMASI',
                    desc: 'Panduan & SOP Operator',
                    color: 'cyan',
                    icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
                    roles: ['Administrator', 'User']
                },
                {
                    id: 'about',
                    title: 'ABOUT APLIKASI',
                    desc: 'Versi & Info Pengembang',
                    color: 'purple',
                    icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>',
                    roles: ['Administrator', 'User']
                }
            ];
            const allowedItems = allMenuItems.filter(item => {
                if (userRole === 'Administrator') return true;
                return item.roles.includes(userRole);
            });
            const cardsHtml = allowedItems.map(item => `
                <div onclick="navigate('${item.id}')" class="menu-card border-${item.color}-500 group">
                    <div class="icon-wrapper text-${item.color}-500 group-hover:text-white transition-colors">
                        <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            ${item.icon}
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold uppercase mb-2 text-gray-100 group-hover:text-${item.color}-400 transition-colors">${item.title}</h2>
                    <p class="text-sm text-gray-400">${item.desc}</p>
                </div>
            `).join('');
            container.innerHTML = `
                <div class="app-view p-6 max-w-7xl mx-auto">
                    ${createHeader('MENU UTAMA', 'Pilih menu untuk melanjutkan', false)}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-10">
                        ${cardsHtml}
                    </div>
                    <footer class="mt-20 text-center text-xs text-gray-600">
                        Aplikasi Monitoring Produksi v1.2
                    </footer>
                </div>
            `;
        }

        // --- HALAMAN MONITOR DASHBOARD (GAUGE/DONUT) ---
        async function renderMonitorDashboard() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="app-view p-6 max-w-7xl mx-auto">
                    ${createHeader('Dashboard Monitor', 'Klik kartu untuk melihat timeline detail')}
                    <div id="loading-indicator" class="text-center py-10 text-gray-400 animate-pulse">
                        Mengambil data Live dari Line Produksi...
                    </div>
                    <div id="summary-section" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
                    <div id="machine-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                    <div class="mt-8 text-center">
                        <button onclick="renderMonitorDashboard()" class="text-sm text-green-400 hover:text-green-300 underline">Refresh Data</button>
                    </div>
                </div>
            `;
            try {
                const result = await fetchSheetData(SHEETS.DASHBOARD);
                dashboardData = result.data;
                dashboardHeaders = result.headers;
                document.getElementById('loading-indicator').classList.add('hidden');
                renderMachineCards(dashboardData);
            } catch (err) {
                const errorContainer = document.getElementById('loading-indicator');
                errorContainer.classList.remove('animate-pulse');
                errorContainer.innerHTML = `
                    <div class="bg-red-900/50 p-4 rounded-lg inline-block border border-red-800">
                        <p class="font-bold text-red-300 mb-1">Gagal Memuat Dashboard</p>
                        <p class="text-sm text-gray-300">${err.message}</p>
                    </div>
                `;
            }
        }

        function renderMachineCards(data) {
            const grid = document.getElementById('machine-grid');
            const summarySection = document.getElementById('summary-section');
            grid.innerHTML = '';
            summarySection.innerHTML = '';
            if (data.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500">Tidak ada data mesin ditemukan. Cek nama sheet "dashboardproses".</div>';
                return;
            }
            let totalQtySelesai = 0;
            let totalTarget = 0;
            data.forEach(row => {
                const qty = parseFloat(row['QTY SELESAI'] || row['QTY_SELESAI'] || 0);
                const wait = parseFloat(row['WAIT PROSES'] || row['WAIT_PROSES'] || 0);
                const trg = parseFloat(row['TARGET'] || (qty + wait));
                totalQtySelesai += qty;
                totalTarget += trg;
            });
            let totalPercentage = 0;
            if (totalTarget > 0) {
                totalPercentage = Math.round((totalQtySelesai / totalTarget) * 100);
            }
            summarySection.classList.remove('hidden');
            summarySection.innerHTML = `
                <div class="summary-card border-emerald-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Qty Selesai</p>
                            <h3 class="text-3xl font-bold text-white mt-1">${formatNumber(totalQtySelesai)}</h3>
                        </div>
                        <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-500">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                    <p class="text-xs text-emerald-400 mt-4">Actual Output</p>
                </div>
                <div class="summary-card border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Plan Qty</p>
                            <h3 class="text-3xl font-bold text-white mt-1">${formatNumber(totalTarget)}</h3>
                        </div>
                        <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        </div>
                    </div>
                    <p class="text-xs text-blue-400 mt-4">Target Production</p>
                </div>
                <div class="summary-card border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Pencapaian Total</p>
                            <h3 class="text-3xl font-bold text-white mt-1">${totalPercentage}%</h3>
                        </div>
                        <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-1.5 mt-4">
                        <div class="bg-purple-500 h-1.5 rounded-full" style="width: ${totalPercentage > 100 ? 100 : totalPercentage}%"></div>
                    </div>
                </div>
            `;
            data.forEach((row, index) => {
                const namaMesin = row['MESIN'] || row['NAME'] || `Mesin ${index+1}`;
                const qtySelesai = parseFloat(row['QTY SELESAI'] || row['QTY_SELESAI'] || 0);
                const waitProses = parseFloat(row['WAIT PROSES'] || row['WAIT_PROSES'] || 0);
                const target = parseFloat(row['TARGET'] || (qtySelesai + waitProses)); 
                let percentage = 0;
                if (target > 0) {
                    percentage = Math.round((qtySelesai / target) * 100);
                }
                const canvasId = `chart-${index}`;
                let progressColor = '#eab308'; 
                if (percentage >= 90) progressColor = '#22c55e';
                if (percentage < 30) progressColor = '#ef4444';
                const cardHtml = `
                    <div onclick="openMachineDetail('${namaMesin}')" class="process-card cursor-pointer hover:bg-zinc-750 transition transform hover:-translate-y-1 hover:ring-2 hover:ring-green-500/50">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-xl font-bold text-white truncate" title="${namaMesin}">${namaMesin}</h3>
                            <span class="text-sm font-mono text-gray-400 whitespace-nowrap">${formatNumber(qtySelesai)} / ${formatNumber(target)}</span>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="${canvasId}"></canvas>
                            <div class="chart-center-text">${percentage}%</div>
                        </div>
                        <div class="flex justify-between items-end mt-2 text-xs text-gray-400 border-t border-gray-700 pt-2">
                            <div>
                                <p>Qty Selesai</p>
                                <p class="text-lg font-bold text-white">${formatNumber(qtySelesai)}</p>
                            </div>
                            <div class="text-right">
                                <p>Wait Proses</p>
                                <p class="text-lg font-bold text-gray-300">${formatNumber(waitProses)}</p>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += cardHtml;
                setTimeout(() => {
                    initChart(canvasId, qtySelesai, (target - qtySelesai), progressColor);
                }, 0);
            });
        }

        function initChart(canvasId, valCompleted, valRemaining, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (valRemaining < 0) valRemaining = 0;
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Selesai', 'Sisa'],
                    datasets: [{
                        data: [valCompleted, valRemaining],
                        backgroundColor: [color, '#52525b'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%', 
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // --- HALAMAN DETAIL MESIN (MODIFIKASI: FOKUS MERAH DAN HIJAU) ---
        async function renderDetailMesin() {
            const container = document.getElementById('app-container');
            if (!selectedMachine) {
                navigate('monitorDashboard');
                return;
            }
            container.innerHTML = `
                <div class="app-view p-6 max-w-7xl mx-auto">
                    ${createHeader(`Timeline: ${selectedMachine}`, 'Visualisasi Jalannya Proses Produksi', true, 'monitorDashboard')}
                    
                    <div class="mb-8 bg-zinc-900 border border-zinc-700 rounded-xl p-4 shadow-lg">
                        <div class="flex justify-between items-center mb-4 border-b border-zinc-800 pb-2">
                            <h3 class="text-white font-bold text-lg">Timeline Produksi Hari Ini (08:00 - 20:00)</h3>
                            <div class="flex gap-4 text-xs text-gray-400">
                                <div class="timeline-legend-item"><span class="timeline-legend-color bg-green-500"></span>Proses Berjalan</div>
                                <div class="timeline-legend-item"><span class="timeline-legend-color bg-red-500"></span>Waktu Luang/Downtime</div>
                            </div>
                        </div>
                        <div class="relative h-40 w-full">
                            <canvas id="timelineChart"></canvas>
                        </div>
                        <div id="timeline-debug" class="text-center text-xs text-gray-500 mt-2 font-mono"></div>
                    </div>

                    <div class="overflow-x-auto shadow-lg rounded-xl border-l-4 border-yellow-500 bg-zinc-800">
                         <div class="p-4 border-b border-zinc-700 flex justify-between items-center bg-zinc-900">
                             <h3 class="text-lg font-bold text-yellow-500">Log Plan Proses</h3>
                         </div>
                        <table class="monitor-table w-full text-left text-sm text-gray-300">
                            <thead id="detail-head" class="bg-zinc-900 uppercase text-xs font-bold text-gray-400 border-b border-zinc-700"></thead>
                            <tbody id="detail-body" class="divide-y divide-zinc-700">
                                <tr><td class="p-6 text-center animate-pulse">Memuat data plan...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            try {
                // Ambil data Plan Proses
                const result = await fetchSheetData(SHEETS.PLAN);
                const data = result.data;
                const headers = result.headers;
                const tbody = document.getElementById('detail-body');
                const thead = document.getElementById('detail-head');
                const debugText = document.getElementById('timeline-debug');
                
                // --- DETEKSI KOLOM OTOMATIS ---
                const allKeys = data.length > 0 ? Object.keys(data[0]) : headers;
                const startKey = allKeys.find(k => k.includes('START') || k.includes('MULAI')) || 'START';
                const finishKey = allKeys.find(k => k.includes('FINISH') || k.includes('SELESAI')) || 'FINISH';
                const machineKey = allKeys.find(k => k.includes('MESIN') || k.includes('NAME') || k.includes('LINE')) || 'MESIN';
                
                // Tampilkan Header Tabel
                const displayHeaders = headers.slice(0, 15);
                thead.innerHTML = '<tr>' + displayHeaders.map(h => `<th class="px-4 py-3 whitespace-nowrap">${h}</th>`).join('') + '</tr>';

                // Filter data berdasarkan Mesin
                const filteredData = data.filter(row => {
                    const mesinVal = row[machineKey] || '';
                    return String(mesinVal).trim() === selectedMachine;
                });

                if (filteredData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${displayHeaders.length}" class="p-6 text-center text-gray-500">Tidak ada data plan untuk mesin ${selectedMachine}.</td></tr>`;
                    debugText.textContent = "Data kosong untuk mesin ini.";
                    return;
                }

                // Urutkan data berdasarkan waktu START
                filteredData.sort((a, b) => {
                    const tA = timeToMinutes(a[startKey]);
                    const tB = timeToMinutes(b[startKey]);
                    return (tA || 0) - (tB || 0);
                });

                // --- LOGIKA CHART FOKUS MERAH DAN HIJAU ---
                const timelineStart = 8 * 60;  // 08:00 (480 menit)
                const timelineEnd = 20 * 60;   // 20:00 (1200 menit)
                
                const processSegments = [];
                let validProcessCount = 0;
                let downtimeSegments = [];
                let currentTime = timelineStart;

                // 1. Kumpulkan semua segmen proses yang valid dan urutkan
                const validProcesses = filteredData.map(row => {
                    let start = timeToMinutes(row[startKey]);
                    let end = timeToMinutes(row[finishKey]);

                    // Pastikan waktu valid dan End > Start
                    if (start === null || end === null || end <= start) return null;
                    
                    // Clamp waktu agar berada dalam rentang 08:00 - 20:00
                    start = Math.max(start, timelineStart);
                    end = Math.min(end, timelineEnd);

                    if (end > start) {
                        validProcessCount++;
                        return { start, end, details: row };
                    }
                    return null;
                }).filter(p => p !== null);

                // Urutkan ulang berdasarkan waktu mulai yang sudah di-clamp
                validProcesses.sort((a, b) => a.start - b.start);
                
                // 2. Gabungkan proses yang tumpang tindih (optional, tapi lebih akurat)
                let mergedProcesses = [];
                if (validProcesses.length > 0) {
                    let current = validProcesses[0];
                    for (let i = 1; i < validProcesses.length; i++) {
                        const next = validProcesses[i];
                        // Jika ada tumpang tindih atau bersentuhan, gabungkan
                        if (next.start <= current.end) {
                            current.end = Math.max(current.end, next.end);
                        } else {
                            mergedProcesses.push(current);
                            current = next;
                        }
                    }
                    mergedProcesses.push(current);
                }

                // 3. Hitung segmen Downtime/Gap (Merah) dan segmen Proses (Hijau)
                currentTime = timelineStart;

                mergedProcesses.forEach(process => {
                    // Cek Downtime sebelum proses ini dimulai
                    if (process.start > currentTime) {
                        downtimeSegments.push({ 
                            x: [currentTime, process.start], 
                            y: selectedMachine, 
                            details: { label: 'Downtime' } 
                        });
                    }
                    
                    // Tambahkan segmen Proses (Hijau)
                    processSegments.push({
                        x: [process.start, process.end],
                        y: selectedMachine,
                        details: process.details 
                    });

                    // Update currentTime ke akhir proses ini
                    currentTime = process.end;
                });
                
                // 4. Tambahkan sisa Downtime hingga timelineEnd
                if (currentTime < timelineEnd) {
                     downtimeSegments.push({ 
                        x: [currentTime, timelineEnd], 
                        y: selectedMachine, 
                        details: { label: 'Downtime' } 
                    });
                }


                debugText.textContent = `Ditemukan ${filteredData.length} baris data. ${validProcessCount} segmen proses valid. Dibuat ${mergedProcesses.length} segmen hijau dan ${downtimeSegments.length} segmen merah.`;

                const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
                chartInstances['timelineChart'] = new Chart(ctxTimeline, {
                    type: 'bar',
                    data: {
                        labels: [selectedMachine], 
                        datasets: [
                            // Dataset 1: Downtime/Gap (Warna Merah) - Harus diletakkan pertama agar berada di belakang
                            {
                                label: 'Waktu Luang/Downtime',
                                data: downtimeSegments,
                                backgroundColor: '#ef4444', // Merah
                                borderColor: '#ef4444',
                                borderWidth: 1,
                                barPercentage: 0.6, 
                                categoryPercentage: 0.8,
                                borderSkipped: false,
                                borderRadius: 4,
                                order: 2 // Order kedua (di belakang Proses Berjalan)
                            },
                            // Dataset 2: Proses Berjalan (Warna Hijau) - Akan menimpa merah
                            {
                                label: 'Proses Berjalan',
                                data: processSegments,
                                backgroundColor: '#22c55e', // Hijau
                                borderColor: '#22c55e',
                                borderWidth: 1,
                                barPercentage: 0.6, 
                                categoryPercentage: 0.8,
                                borderSkipped: false,
                                borderRadius: 4,
                                order: 1 // Order pertama (di depan Downtime)
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                min: timelineStart,
                                max: timelineEnd,
                                stacked: true, // WAJIB STACKED: agar bar merah dan hijau bisa bertumpuk di sumbu X
                                grid: { 
                                    color: '#3f3f46', 
                                    drawOnChartArea: true,
                                },
                                ticks: {
                                    color: '#9ca3af',
                                    stepSize: 60, // Per jam
                                    callback: function(value) { return minutesToTime(value); }
                                }
                            },
                            y: {
                                stacked: true, // WAJIB STACKED: agar bar merah dan hijau bisa bertumpuk di sumbu Y (kategori)
                                grid: { display: false },
                                ticks: { display: true, color: 'white', font: {weight: 'bold'} } 
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const raw = context.raw;
                                        const label = context.dataset.label;
                                        if (raw.x && Array.isArray(raw.x)) {
                                            const s = minutesToTime(raw.x[0]);
                                            const e = minutesToTime(raw.x[1]);
                                            const duration = (raw.x[1] - raw.x[0]).toFixed(0);
                                            return `${label}: ${s} - ${e} (${duration} min)`;
                                        }
                                        return '';
                                    }
                                }
                            },
                            legend: { display: false } 
                        }
                    }
                });

                // --- RENDER TABEL ---
                tbody.innerHTML = filteredData.map(row => {
                    let rowClass = 'bg-zinc-800 text-gray-300 hover:bg-zinc-700 transition';
                    // Logika warna baris sederhana
                    const valL = row[displayHeaders[11]] ? String(row[displayHeaders[11]]).trim() : '';
                    if (valL) rowClass = 'bg-gray-700 text-white';

                    const cellsHtml = displayHeaders.map(h => {
                        let cellVal = row[h] !== undefined ? row[h] : '';
                        // Format kolom waktu di tabel agar rapi
                        if (h === startKey || h === finishKey) {
                           // Coba parsing dulu, kalau berhasil format ulang
                           const m = timeToMinutes(cellVal);
                           if (m !== null) cellVal = minutesToTimeWithSeconds(m);
                        }
                        return `<td class="px-4 py-3 whitespace-nowrap">${cellVal}</td>`;
                    }).join('');
                    return `<tr class="${rowClass} border-b border-zinc-700">${cellsHtml}</tr>`;
                }).join('');

            } catch (err) {
                console.error(err);
                document.getElementById('detail-body').innerHTML = `
                    <tr><td colspan="15" class="p-6 text-center text-red-500">
                        Error: ${err.message}<br>
                        <small class="text-gray-500">Cek konsol browser untuk detail.</small>
                    </td></tr>`;
            }
        }

        // --- HALAMAN KONTROL MESIN ---
        function renderKontrolMesin() {
            const container = document.getElementById('app-container');
            let optionsHtml = '<option value="">-- Pilih Mesin --</option>';
            if (dashboardData.length > 0) {
                dashboardData.forEach(row => {
                    const m = row['MESIN'] || row['NAME'];
                    if (m) optionsHtml += `<option value="${m}">${m}</option>`;
                });
            } else {
                fetchSheetData(SHEETS.DASHBOARD).then(res => {
                    dashboardData = res.data;
                    renderKontrolMesin(); 
                }).catch(e => {
                    optionsHtml = '<option value="">Gagal memuat list mesin</option>';
                });
                optionsHtml = '<option>Memuat data mesin...</option>';
            }
            container.innerHTML = `
                <div class="app-view p-6 max-w-4xl mx-auto">
                    ${createHeader('Kontrol Mesin', 'Update Status & Output')}
                    <div class="bg-zinc-800 p-8 rounded-xl shadow-lg border-l-4 border-red-500">
                        <form onsubmit="handleSubmitData(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Nama Mesin / Line</label>
                                    <select name="mesin" id="inputMesin" class="form-input" required>
                                        ${optionsHtml}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Jenis Update</label>
                                    <select name="jenis" class="form-input">
                                        <option value="UPDATE_QTY">Update Qty Selesai</option>
                                        <option value="SET_TARGET">Set Target Baru</option>
                                        <option value="STOP_MESIN">Stop / Downtime</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Nilai / Jumlah</label>
                                    <input type="number" name="nilai" class="form-input" placeholder="0" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Keterangan</label>
                                    <input type="text" name="keterangan" class="form-input" placeholder="Opsional">
                                </div>
                            </div>
                            <div id="form-feedback" class="hidden mb-4 p-3 rounded text-sm text-center font-bold"></div>
                            <button type="submit" id="btn-submit" class="w-full btn-primary bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700">
                                KIRIM UPDATE
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }

        async function handleSubmitData(e) {
            e.preventDefault();
            const form = e.target;
            const btn = document.getElementById('btn-submit');
            const feedback = document.getElementById('form-feedback');
            const formData = new FormData(form);
            const payload = {
                action: 'UPDATE_PRODUKSI', 
                mesin: formData.get('mesin'),
                jenis: formData.get('jenis'),
                nilai: formData.get('nilai'),
                keterangan: formData.get('keterangan'),
                user: currentUser.username,
                timestamp: new Date().toISOString()
            };
            btn.disabled = true;
            btn.textContent = 'Mengirim...';
            feedback.classList.add('hidden');
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                feedback.textContent = 'Data Berhasil Dikirim!';
                feedback.className = 'mb-4 p-3 rounded text-sm text-center font-bold bg-green-900 text-green-200 block';
                form.reset();
                dashboardData = []; 
            } catch (err) {
                feedback.textContent = 'Gagal mengirim data. Cek koneksi.';
                feedback.className = 'mb-4 p-3 rounded text-sm text-center font-bold bg-red-900 text-red-200 block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'KIRIM UPDATE';
            }
        }

        // --- HALAMAN DETAIL PROGRESS ---
        async function renderDetailProgress() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="app-view p-6 max-w-7xl mx-auto">
                    ${createHeader('Detail Progress', 'Data Mentah Produksi')}
                    <div class="overflow-x-auto shadow-lg rounded-xl border-l-4 border-emerald-500">
                        <table class="monitor-table w-full text-left text-sm text-gray-300">
                            <thead class="bg-zinc-900 uppercase text-xs font-bold text-gray-400 border-b-2 border-emerald-500/50">
                                <tr id="table-head"></tr>
                            </thead>
                            <tbody id="table-body" class="divide-y divide-zinc-700">
                                <tr><td class="p-4 text-center">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            try {
                const result = await fetchSheetData(SHEETS.DETAIL);
                const headers = result.headers;
                const data = result.data;
                const thead = document.getElementById('table-head');
                const tbody = document.getElementById('table-body');
                thead.innerHTML = headers.map(h => `<th class="px-6 py-4 whitespace-nowrap">${h}</th>`).join('');
                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${headers.length}" class="p-6 text-center text-gray-500">Data kosong.</td></tr>`;
                    return;
                }
                tbody.innerHTML = data.map(row => `
                    <tr class="hover:bg-zinc-700 transition">
                        ${headers.map(h => `<td class="px-6 py-4 whitespace-nowrap">${row[h]}</td>`).join('')}
                    </tr>
                `).join('');
            } catch (err) {
                document.getElementById('table-body').innerHTML = `<tr><td class="p-4 text-center text-red-500 font-bold">Gagal: ${err.message}</td></tr>`;
            }
        }

        // --- HALAMAN INFORMASI ---
        function renderInformasi() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="app-view p-6 max-w-4xl mx-auto">
                    ${createHeader('Informasi', 'Panduan Operator')}
                    <div class="bg-zinc-800 p-8 rounded-xl shadow-lg text-gray-300 space-y-4 border-l-4 border-cyan-500">
                        <h3 class="text-xl font-bold text-white">Cara Membaca Dashboard</h3>
                        <ul class="list-disc pl-5 space-y-2">
                            <li><strong>Grafik Donut:</strong> Menunjukkan persentase penyelesaian target hari ini.</li>
                            <li><strong>Warna Kuning:</strong> Proses berjalan normal (Standard).</li>
                            <li><strong>Warna Hijau:</strong> Pencapaian target > 90% (Excellent).</li>
                            <li><strong>Warna Merah:</strong> Pencapaian < 30% atau ada downtime.</li>
                        </ul>
                        <div class="border-t border-gray-700 my-4"></div>
                        <h3 class="text-xl font-bold text-white">Prosedur Update Data</h3>
                        <p>Operator atau Admin wajib melakukan update data melalui menu "Kontrol Mesin" setiap:</p>
                        <ol class="list-decimal pl-5 space-y-1">
                            <li>Pergantian Shift.</li>
                            <li>Mesin Breakdown/Stop lebih dari 15 menit.</li>
                            <li>Pencapaian output per jam.</li>
                        </ol>
                    </div>
                </div>
            `;
        }

        // --- HALAMAN ABOUT ---
        function renderAbout() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="app-view p-6 max-w-4xl mx-auto">
                    ${createHeader('About Aplikasi', 'Versi 1.2')}
                    <div class="bg-zinc-800 p-8 rounded-xl shadow-lg text-center border-l-4 border-purple-500">
                        <div class="h-20 w-20 bg-green-900 rounded-full mx-auto flex items-center justify-center mb-4">
                             <span class="text-4xl"></span>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Monitoring Production System</h2>
                        <p class="text-gray-400 mb-6">Dikembangkan untuk memantau efisiensi (OEE) dan output line produksi secara real-time.</p>
                        <div class="grid grid-cols-2 gap-4 text-left max-w-md mx-auto text-sm bg-zinc-900 p-4 rounded-lg border border-zinc-700">
                            <div class="text-gray-500">Versi</div><div class="text-white">1.2.0 (RBAC Enabled)</div>
                            <div class="text-gray-500">Database</div><div class="text-white">Google Sheets</div>
                            <div class="text-gray-500">Status</div><div class="text-green-400">Online</div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.navigate = navigate;
        window.handleLoginSubmit = handleLoginSubmit;
        window.renderMonitorDashboard = renderMonitorDashboard;
        window.handleSubmitData = handleSubmitData;
        window.openMachineDetail = openMachineDetail;
        window.handleLogout = () => {
            sessionStorage.removeItem('monitorUser');
            currentUser = null;
            navigate('login');
        };

        window.onload = () => {
            const storedUser = sessionStorage.getItem('monitorUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                navigate('mainMenu'); 
            } else {
                navigate('login');
            }
        }
    </script>
</body>
</html>
